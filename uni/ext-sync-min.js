/*!
 * Extension for Ext JS core library 
 * by Farshad Mohajeri for uniGUI Library    
 * Copyright(c) 2009-2015 FMSoft Inc.
 * info@fmsoft.net
 * http://www.unigui.com
!*/
var logEnabled=true;var sendQEnabled=true;var RST_ID=4294967295;var uniSyncObj={concurrentRequests:2,requestId:0,inCallback:0,activeRequests:0,pendingRequests:0,timerSkip:0,recvQ:[],auxSendQ:[],sendQ:[],failedQ:[],lastRecId:-1,lastSentId:-1,recoveryMode:false,fMode:true,ttimer:null,fCnt:0,retryInterval:3,initialWait:10,maxAuxQLen:64,recvRecoveryCnt:0,failedQChunk:4,commAvail:true,errText:"Communication error.",errRetryText:"Retrying...",errShow:true,errTextColor:"#0055aa",debug:false};function _log(a){if(logEnabled&&typeof console!="undefined"){console.log(a)}return(a)}function callTryFinally(b,a){return function(){var d=true;if(arguments){var c=Array.prototype.slice.call(arguments);c.splice(0,0,null);c.splice(0,0,true);var e=a.apply(this,c);if(e===false){return(false)}if(e&&e.res===false){return(false)}try{if(e.callOrg!==false){d=b.apply(this,arguments)}}finally{c[0]=false;c[1]=d;if(a.apply(this,c)===false){return(false)}}}return(d)}}Ext.override(Ext.data.Connection,{statics:{},startTimer:function(a,d){var c=this,b=uniSyncObj;if(d&&b.ttimer){return}if(!a){a=0}b.timerSkip=a;if(!b.ttimer){b.fCnt=0;if(b.debug){_log("start")}b.ttimer=setInterval(function(){c.timerHandle(c)},1000)}},stopTimer:function(){var a=uniSyncObj;if(a.ttimer){if(a.debug){_log("stop")}clearInterval(a.ttimer);delete a.ttimer}},timerHandle:function(b){var a=uniSyncObj;if(a.recoveryMode){this.setOverlayText(a.fCnt++)}if(a.timerSkip){if(--a.timerSkip>0){return}if(a.commAvail){a.timerSkip=1}else{a.timerSkip=a.retryInterval}}if(a.debug){_log("tick")}b.processFailedQueue(a.commAvail);b.processQueues()},checkStatus:function(b){var a=uniSyncObj;if(b&&a.sendQ.length==0&&a.failedQ.length==0){if(a.recvQ.length==0){this.stopTimer()}if(a.recoveryMode){a.recoveryMode=false;a.fCnt=0;this.processAuxQueue();this.hideOverlay()}}},hideOverlay:function(){var a=uniSyncObj;if(a.overlay){a.overlay.destroy();delete a.overlay}},setOverlayText:function(c){var a=uniSyncObj;if(a.overlay&&a.errShow){var b=document.getElementById("OVLAY_ID_TXT");if(b){b.innerHTML=a.errRetryText+" "+c}}},showOverlay:function(b){var a=uniSyncObj;if(!a.overlay){a.overlay=Ext.getBody().createChild({cls:"x-mask x-mask-overlay",html:'<table style="width: 100%; height: 100%"><tr style="vertical-align: central"><td style="z-index:2000001;text-align: center; color:'+a.errTextColor+'">'+(b?"<br><br><br><br><p>"+a.errText+" "+a.err+'</p><p id="OVLAY_ID_TXT"></p></td></tr></table>':"")});if(a.overlay.unselectable){a.overlay.unselectable()}a.overlay.dom.style.zIndex=2000000;a.overlay.show()}},handleFailure:function(d,c){var b=uniSyncObj;b.recoveryMode=true;b.err="";if(c){b.err=c.statusText+" : "+c.status;d.options.rejected=(c.status==401)}this.showOverlay(b.errShow&&!b.commAvail);if(b.failedQ.length==0){var a=b.initialWait;if(b.commAvail){a=2}this.startTimer(a,true)}b.failedQ.push(d.options)},initParams:function(){var a=uniSyncObj;if(a.paramsInited){return}a.paramsInited=true;switch(true){case Ext.isIE8:case Ext.isIE9:case Ext.isIE10:case Ext.isIE11:a.concurrentRequests=window.maxConnectionsPerServer;break;case Ext.isIE:a.concurrentRequests=2;break;case Ext.isSafari:case Ext.isChrome:case Ext.isGecko:case Ext.isGecko3:case Ext.isGecko4:case Ext.isGecko5:case Ext.isGecko10:a.concurrentRequests=4;break}},prepareOptions:function(c){var g=false;this.initParams();c.uid=undefined;if(c.isUpload){return}var e=Ext.isObject(c.params);var f=(typeof c.params=="string");if(e){if(c.params._S_ID){g=true}else{if(c.url){if(c.url.indexOf("&_S_ID=")>=0){g=true}}}}else{if(f){var b=c.params;if(b.indexOf("&_S_ID=")>=0||b.indexOf("=_S_ID=")>=0){g=true}}}var d=uniSyncObj.requestId;var a=uniSyncObj.inCallback;if(g){uniSyncObj.requestId++}c.fromSendQ=false;c.uid=d;if(g){if(f){c.params+="&_seq_="+d.toString(16);if(a>0){c.params+="&_a_=1"}}else{if(e){c.params._seq_=d.toString(16);if(a>0){c.params._a_=1}}}}},request:callTryFinally(Ext.data.Connection.prototype.request,function(c,f,d){if(c){if(d.fromSendQ){return(true)}if(uniSyncObj.recoveryMode){if(uniSyncObj.auxSendQ.length>=uniSyncObj.maxAuxQLen){return({res:true,callOrg:false})}}this.prepareOptions(d);if(d.uid==undefined){return(true)}if(d.obj){try{_hreq_(d.obj,d.url,d.params);var a=d.obj;if(!(a.isXType&&a.isXType("window"))){_shm_(d.obj)}}catch(g){alert("request : "+g.message)}}if(d.async===false){return(true)}if(sendQEnabled){if(uniSyncObj.recoveryMode){uniSyncObj.auxSendQ.push(d)}else{uniSyncObj.sendQ.push(d)}this.processSendQueue();return({res:true,callOrg:false})}}else{if(d.reqBusy!==true&&d.obj&&d.e&&d.obj.retfalse&&d.obj.retfalse[d.e]){return(false)}}return(true)}),pushRecv:function(a){a.buffered=true;uniSyncObj.recvQ.push({request:a});this.clearActiveRequest(a)},onComplete:callTryFinally(Ext.data.Connection.prototype.onComplete,function(k,i,f){var j=this,m=uniSyncObj,r=f.options,d=r.uid,n=f.xhr,g=false,q=m.fMode;if(k){if(r.fromSendQ){if(m.pendingRequests){m.pendingRequests--}}if(r.async===false){return(true)}if(r.uid==undefined){return(true)}if(f.buffered){return(true)}if(q){g=n&&(n.status!=200)}if(g){return(true)}if(d-m.lastRecId<=1){return(true)}else{this.pushRecv(f);return(false)}}else{if(r){try{var l=(i.status==200);m.commAvail=(i.status==200)||(i.status==401);r.done=l;if(i.status==401){var p=i.responseText;var c=(p=="F");if(c){m.lastRecId=RST_ID;if(m.debug){_log("Forcefully reset")}}}if(l&&r.obj&&typeof i.responseText=="string"){_hcbk_(r.obj,i.responseText)}}finally{try{if(l){if(m.debug){_log("Success: "+r.uid)}if(r.uid>m.lastSentId){m.lastSentId=r.uid}}this.checkStatus(l);if(q&&!l){this.handleFailure(f,i)}else{var a=r.obj;if(a){try{if(!a.mevent||a.mevent==r.event){a.mevent=undefined;_hde_(a)}}catch(h){alert("onComplete : "+h.message)}a.sendBusy=false}}}finally{this.postComplete(f)}}}}return(true)}),processQueues:function(){try{this.processSendQueue()}finally{this.processRecvQueue()}},clearActiveRequest:function(b){var a=b.options;if(a.fromSendQ){a.fromSendQ=false;if(uniSyncObj.activeRequests){uniSyncObj.activeRequests--}}},postComplete:function(b){var a=b.options;try{if(a.uid!==undefined){this.clearActiveRequest(b);var c=a.uid;if(!uniSyncObj.fMode||a.done){if(c>=0&&(uniSyncObj.lastRecId<c||uniSyncObj.lastRecId==RST_ID)){uniSyncObj.lastRecId=c}}}}finally{if(uniSyncObj.commAvail){this.processFailedQueue(true)}this.processQueues()}},cleanup:callTryFinally(Ext.data.Connection.prototype.cleanup,function(a,c,d){if(d.buffered===true){return(false)}return(true)}),sortQ:function(a){if(a.length>0){if(a.sort){a.sort(function(c,b){if(c&&b){if(c.uid>=0){return c.uid-b.uid}else{if(c.request&&c.request.options){return c.request.options.uid-b.request.options.uid}}}return 0})}}},processSendQueue:function(){var a=uniSyncObj,b=null;if(a.sendQ.length>0){if(a.fMode&&a.sendQ.length>1){this.startTimer(a.retryInterval,true)}this.sortQ(a.sendQ);while(a.activeRequests<a.concurrentRequests){b=a.sendQ.shift();if(b){a.activeRequests++;a.pendingRequests++;b.fromSendQ=true;if(b.obj){b.obj.sendBusy=true}b.reqBusy=true;try{return(this.request(b))}finally{b.reqBusy=false}}}}},processRecvQueue:function(){var c=null,a=uniSyncObj;if(a.recvQ.length>0){this.sortQ(a.recvQ);var b=a.recvQ[0].request;if(b.options.uid-a.lastRecId<=1){c=b;a.recvQ.splice(0,1)}if(c){a.recvRecoveryCnt=0;try{this.onComplete(c)}finally{c.buffered=false;this.cleanup(c)}}else{if(a.pendingRequests==0&&a.sendQ.length==0){a.recvRecoveryCnt++;if(a.recvRecoveryCnt>5){a.recvRecoveryCnt=0;a.lastRecId=a.recvQ[0].request.options.uid;if(a.debug){_log("RecvQ deadlock recover.")}}}}}},processAuxQueue:function(){var a=uniSyncObj;while(a.auxSendQ.length>0){var b=a.auxSendQ.shift();if(b){a.sendQ.push(b)}}},addOptionParam:function(d,a,c){var b=d.params;if(typeof b=="string"){d.params+="&"+a+"="+c}else{if(Ext.isObject(b)){d.params[a]=c}}},processFailedQueue:function(c){var a=uniSyncObj,b=0;this.sortQ(a.failedQ);while(a.failedQ.length>0){var d=a.failedQ.shift();if(d){if(sendQEnabled){if(!d.fromFailedQ){d.fromFailedQ=true;this.addOptionParam(d,"_f_",1)}a.sendQ.push(d);if(!c){if(++b>=a.failedQChunk){break}}}}}}});Ext.override(Ext,{callback:callTryFinally(Ext.callback,function(a){if(a){uniSyncObj.inCallback++}else{uniSyncObj.inCallback--}return(true)})});